sudo: required
dist: trusty
language: cpp
services:
- docker
matrix:
  include:
  - os: linux
    env:
    - OS="Linux"
    - NODE_VERSION="6.9.0"
    - CB_VERSION="enterprise-4.5.1"
  - os: osx
    env:
    - NODE_VERSION="6.9.0"
    - CB_VERSION="enterprise-4.5.1"
before_install:
- rm -rf ~/.nvm/ && git clone --depth 1 https://github.com/creationix/nvm.git ~/.nvm
- source ~/.nvm/nvm.sh
- nvm install $NODE_VERSION
- nvm use $NODE_VERSION
- npm install -g json
- if [[ "$TRAVIS_OS_NAME" == "linux" ]]; then docker pull corbinu/couchbase-test:$CB_VERSION;
  docker pull corbinu/alpine-node-builder; fi;
- if [[ "$TRAVIS_OS_NAME" == "linux" ]]; then export CB_ID=$(docker run -d -p 8091:8091
  --env BUCKET=default corbinu/couchbase-test:$CB_VERSION); fi;
- if [[ "$TRAVIS_OS_NAME" == "linux" ]]; then CBRES=0; while [ $CBRES != 1 ]; do echo
  -n '.'; R=$(docker inspect $CB_ID | json -a State.Running); if [ "$R" == "true"
  ]; then let CBRES=1; else sleep 1.3; fi; done; fi;
- if [[ "$TRAVIS_OS_NAME" == "linux" ]]; then export CB_IP=$(docker inspect --format
  '{{ .NetworkSettings.IPAddress}}' $CB_ID); fi;
- if [[ "$TRAVIS_OS_NAME" == "linux" ]]; then export CNCSTR="http://$CB_IP:8091/";
  fi;
- if [[ "$TRAVIS_OS_NAME" == "linux" ]]; then docker exec -it $CB_ID couchbase-bootstrap
  bootstrap; fi;
install:
- export PATH=./node_modules/.bin/:$PATH
- npm install
- if [[ "$TRAVIS_OS_NAME" == "linux" ]]; then make test; fi;
- mkdir -p prebuilds/@corbinu
- if [[ "$TRAVIS_BRANCH" = "master" ]]; then prebuild --upload $GITHUB_TOKEN -b 6.0.0
  -b 5.6.0 -b 4.3.0; fi;
- if [[ "$TRAVIS_BRANCH" = "master" ]]; then if [[ "$TRAVIS_OS_NAME" == "linux" ]];
  then docker run -t --volume "$(pwd):/install" corbinu/alpine-node-builder prebuild
  --libc=musl --upload $GITHUB_TOKEN -b 7.0.0 -b 6.9.1 -b 4.6.1; fi; fi;
script:
- echo done
deploy:
  provider: npm
  email: corbinu@openswimsoftware.com
  api_key:
    secure: YH8ZTPYYQVxOWwNOGauPgmE5/SctgcaJsqggOIg5HRb7TZqYIL3zxSi8uYRxbh9mUCwqnx7QtWr3pQv1WAS0f5Sii0SKYHOmn3af6VBeV/Pga8u1jiA/TkH/l6LqDRjnP/MPFQ82c4ZhTAp/fFQet8/c7YMb21JfNXHbOUJ44fB4cOWreuDurlJVhI5Qh/3RIW+ZjTFKgF9RrJA8NaDfKl60lshlhCxZjn+CuatQbhCsrA5gfeBKrtlM+Z4DLEJ4ScOO0bU2YXLMwx+hB7Sj8TLDntuQ1pGb9MezELrvREQVuqAxWgi1EaNs1B+2Op++fElW2yKWgUPButgvgilWUJpltJuAe273tFXeGyl3owJvfvZ9AmUe76n8tZ8WLZGBnvw7XnVw6OLUW6l9vSRsNmVLXCR1NG7r2mpbkvuIBDQ68tN0CMj+acXE/7IXdNbqjSQTBUzMY/YxXMdrwZJ8rM8+qr3F3/wa8wZNtxuPjRSAPUy4rmJMpQboinjGfhJ/xfvfji2yQe8v8rycn+I0iHSnLazMIoC3rzTNvYzZGRPe/1V0YFTwo0suF5WtfK1pfdKWlJnPViNo41wBcCAHcZ5f/GyFWEWOoAia3GGOZzZ9Zvxmy5yFRKT0oFfHfyPn76RTk4AiDpyFdQbAGe4g8GQaEFwJUpahgOTALh0YmXk=
  on:
    tags: true
    condition: $TRAVIS_OS_NAME == "linux"
    repo: corbinu/couchnode
